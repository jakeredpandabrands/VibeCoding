<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Play — COOL STUFF!</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="container play-view">
    <header>
      <h1>COOL STUFF!</h1>
      <p class="tagline" id="tagline">The blind auction</p>
    </header>

    <div id="app">
      <div id="waiting" class="card">
        <p>Waiting for host to start...</p>
      </div>

      <div id="play-phase" class="card hidden">
        <h2>Round <span id="round-num"></span></h2>
        <div class="item-card">
          <span class="item-name" id="item-name"></span>
          <p id="min-bid-hint" class="min-bid hidden"></p>
        </div>

        <div id="bid-form" class="action-form">
          <p id="bid-error" class="error hidden"></p>
          <div id="bid-option" class="action-option">
            <h4>Bid on this item</h4>
            <div class="field">
              <label for="bid-amount">Your bid ($)</label>
              <input type="number" id="bid-amount" min="0" step="1" placeholder="0" inputmode="numeric">
            </div>
            <button id="btn-bid" type="button" class="btn-primary">Place Bid</button>
          </div>
          <div id="cant-afford" class="action-option hidden">
            <p class="cant-afford-msg">You ain't ready for the big leagues yet.</p>
            <p class="hint">Need <strong id="need-amount">$1,000</strong> to bid. Use Pawn Shop to trade up.</p>
          </div>
          <div id="pawn-option" class="action-option pawn-card">
            <h4>Pawn Shop</h4>
            <p class="hint">Skip this round’s bid. Optional: sell an item for 75% to boost your bankroll.</p>
            <div id="sell-option" class="field hidden">
              <label for="sell-select">Sell an item</label>
              <select id="sell-select">
                <option value="">— Keep it —</option>
              </select>
            </div>
            <button id="btn-pawn" type="button" class="btn-secondary">Visit Pawn Shop</button>
          </div>
        </div>

        <div id="submitted" class="hidden">
          <p class="status">Submitted! Waiting for others...</p>
          <p id="my-action-summary"></p>
        </div>
      </div>

      <div id="reveal-phase" class="card hidden">
        <h2>Result</h2>
        <div class="reveal-card">
          <span class="item-name" id="reveal-item-name"></span>
          <span class="item-value" id="reveal-item-value"></span>
          <p id="winner-text"></p>
        </div>
        <p class="status">Wait for host to start next round...</p>
      </div>

      <div id="ended-phase" class="card hidden">
        <h2>Game Over!</h2>
        <ul id="leaderboard"></ul>
        <h3>Your collection</h3>
        <ul id="my-collection"></ul>
      </div>

      <aside class="leaderboard-mini">
        <p class="bankroll">Your bankroll: <strong id="my-bankroll">—</strong></p>
        <h3>Standings</h3>
        <ul id="standings"></ul>
      </aside>
    </div>
  </main>
  <script>
    const GAME_ID = "{{ game_id }}";
    const PLAYER_ID = "{{ player_id }}";
    const API = `/api/game/${GAME_ID}`;

    const waiting = document.getElementById("waiting");
    const playPhase = document.getElementById("play-phase");
    const revealPhase = document.getElementById("reveal-phase");
    const endedPhase = document.getElementById("ended-phase");
    const bidForm = document.getElementById("bid-form");
    const submitted = document.getElementById("submitted");
    const sellOption = document.getElementById("sell-option");

    function show(el) { el?.classList.remove("hidden"); }
    function hide(el) { el?.classList.add("hidden"); }

    async function fetchState() {
      const r = await fetch(`${API}/state?player_id=${PLAYER_ID}`);
      return r.json();
    }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    let lastCollectionJson = "";
    function render(state) {
      // Bankroll (own only)
      const bankrollEl = document.getElementById("my-bankroll");
      bankrollEl.textContent = state.my_budget != null ? `$${state.my_budget}` : "—";

      // Standings (always visible when we have data)
      const standings = document.getElementById("standings");
      if (state.leaderboard?.length) {
        standings.innerHTML = state.leaderboard
          .map((p, i) => `<li>${i + 1}. ${escapeHtml(p.name)} — ${p.total_value}</li>`)
          .join("");
      }

      if (state.phase === "lobby") {
        show(waiting); hide(playPhase); hide(revealPhase); hide(endedPhase);
      } else if (state.phase === "play") {
        hide(waiting); show(playPhase); hide(revealPhase); hide(endedPhase);

        document.getElementById("round-num").textContent = state.current_round + 1;
        document.getElementById("item-name").textContent = state.current_item?.name || "—";
        const minBidEl = document.getElementById("min-bid-hint");
        const minBidVal = state.current_item?.min_bid || 0;
        if (minBidVal > 0) {
          minBidEl.textContent = `Big-ticket item — minimum bid: $${minBidVal.toLocaleString()}`;
          minBidEl.dataset.minBid = String(minBidVal);
          minBidEl.classList.remove("hidden");
        } else {
          minBidEl.dataset.minBid = "0";
          minBidEl.classList.add("hidden");
        }
        document.getElementById("bid-form").dataset.budget = String(state.my_budget ?? 0);

        if (state.has_submitted) {
          hide(bidForm); show(submitted);
          const act = state.my_action;
          let msg = "";
          if (act?.sit_out) {
            msg = "You visited the Pawn Shop";
            if (act.sell_item !== undefined && act.sell_item !== null) {
              msg += " and sold an item";
            }
          } else {
            msg = "You bid!";
          }
          document.getElementById("my-action-summary").textContent = msg;
        } else {
          show(bidForm); hide(submitted);
          document.getElementById("bid-error").classList.add("hidden");

          const minBid = state.current_item?.min_bid || 0;
          const budget = state.my_budget ?? 0;
          const canAfford = budget >= minBid;

          const bidOption = document.getElementById("bid-option");
          const cantAfford = document.getElementById("cant-afford");
          const needAmount = document.getElementById("need-amount");

          if (canAfford) {
            show(bidOption); hide(cantAfford);
          } else {
            hide(bidOption); show(cantAfford);
            needAmount.textContent = `$${(minBid || 0).toLocaleString()}`;
          }

          // Sell dropdown: only rebuild when collection changed
          const coll = state.my_collection || [];
          const collJson = JSON.stringify(coll.map((it) => it.name + it.value));
          const sel = document.getElementById("sell-select");
          const prevVal = sel.value;
          if (collJson !== lastCollectionJson) {
            lastCollectionJson = collJson;
            sel.innerHTML = '<option value="">— Keep it —</option>' +
              coll.map((it, i) => `<option value="${i}">${escapeHtml(it.name)} (75% = $${Math.floor(it.value * 0.75).toLocaleString()})</option>`).join("");
            if (prevVal && coll.length > 0) sel.value = prevVal;
          }

          if (coll.length > 0) {
            show(sellOption);
          } else {
            hide(sellOption);
          }
        }
      } else if (state.phase === "reveal") {
        hide(waiting); hide(playPhase); show(revealPhase); hide(endedPhase);

        document.getElementById("reveal-item-name").textContent = state.resolved?.item_name || "";
        document.getElementById("reveal-item-value").textContent =
          state.resolved ? `Value: ${state.resolved.item_value}` : "";
        document.getElementById("winner-text").textContent = state.resolved?.winner_name
          ? `${state.resolved.winner_name} won!`
          : "No one bid.";
      } else if (state.phase === "ended") {
        hide(waiting); hide(playPhase); hide(revealPhase); show(endedPhase);

        document.getElementById("leaderboard").innerHTML = state.leaderboard
          .map((p, i) => `<li class="rank-${i + 1}">${i + 1}. ${escapeHtml(p.name)} — ${p.total_value}</li>`)
          .join("");

        const myColl = state.my_collection || [];
        document.getElementById("my-collection").innerHTML = myColl.length
          ? myColl.map(it => `<li>${escapeHtml(it.name)} (${it.value})</li>`).join("")
          : "<li>No items won</li>";
      }
    }

    document.getElementById("btn-bid").onclick = async () => {
      const bidInput = document.getElementById("bid-amount");
      const errEl = document.getElementById("bid-error");
      errEl.classList.add("hidden");
      const amt = parseInt(bidInput.value, 10);
      if (isNaN(amt) || amt < 0) {
        errEl.textContent = "Enter a valid bid amount.";
        errEl.classList.remove("hidden");
        return;
      }
      const minBid = parseInt(document.getElementById("min-bid-hint")?.dataset.minBid || "0", 10) || 0;
      const budget = parseInt(document.getElementById("bid-form")?.dataset.budget || "0", 10) || 0;
      if (minBid > 0 && amt < minBid) {
        errEl.textContent = `Minimum bid for this item is $${minBid.toLocaleString()}.`;
        errEl.classList.remove("hidden");
        return;
      }
      if (amt > budget) {
        errEl.textContent = `You only have $${budget.toLocaleString()}. Can't bid more than your bankroll.`;
        errEl.classList.remove("hidden");
        return;
      }
      const r = await fetch(`${API}/action`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player_id: PLAYER_ID, sit_out: false, bid: amt }),
      });
      const data = await r.json().catch(() => ({}));
      if (r.ok && data.ok) {
        poll();
      } else {
        errEl.textContent = data.error || "Something went wrong.";
        errEl.classList.remove("hidden");
      }
    };

    document.getElementById("btn-pawn").onclick = async () => {
      const sellSelect = document.getElementById("sell-select");
      const errEl = document.getElementById("bid-error");
      errEl.classList.add("hidden");
      const v = sellSelect.value;
      const payload = {
        player_id: PLAYER_ID,
        sit_out: true,
        sell_item: v === "" ? null : parseInt(v, 10),
      };
      const r = await fetch(`${API}/action`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await r.json().catch(() => ({}));
      if (r.ok && data.ok) {
        poll();
      } else {
        errEl.textContent = data.error || "Something went wrong.";
        errEl.classList.remove("hidden");
      }
    };

    function poll() {
      fetchState().then(s => {
        document.body.dataset.collection = JSON.stringify(s.my_collection || []);
        render(s);
      });
    }

    setInterval(poll, 2500);
    poll();
  </script>
</body>
</html>
